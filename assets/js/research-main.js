/**
 * Dynamic Article System for GitHub Pages
 * 
 * This script:
 * 1. Loads article data from a JSON file generated by Jekyll
 * 2. Shows the most recent articles at the top
 * 3. Creates a paginated list of older articles
 * 4. Provides search and filtering functionality
 */

// This variable will hold all articles once loaded
let articles = [];

// Function to create article HTML
function createArticleHTML(article, isFeatured = false) {
    const style = isFeatured ? 'background-color: rgba(88, 166, 255, 0.1); border-color: rgba(88, 166, 255, 0.3);' : '';
    const thumbnailHTML = article.thumbnail ? 
        `<div class="research-thumbnail">
            <img src="${article.thumbnail}" alt="${article.title}">
        </div>` : '';
    
    // Check if article is new
    const isNew = isNewArticle(article.date);
    const newBadge = isNew ? '<span class="new-badge">NEW</span>' : '';
    
    // Create tag badges if available
    let tagBadges = '';
    if (article.tags && article.tags.length > 0) {
        tagBadges = '<div class="article-tags">';
        article.tags.forEach(tag => {
            tagBadges += `<span class="article-tag" data-tag="${tag}">${tag}</span>`;
        });
        tagBadges += '</div>';
    }
    
    return `
        <div class="research-item" style="${style}" data-article-id="${article.id}">
            ${newBadge}
            ${thumbnailHTML}
            <div class="research-content">
                <h2 class="research-title">${article.displayTitle || article.title}</h2>
                <div class="research-meta">Published: ${formatDate(article.date)}${article.author ? ' by <span class="author-name">' + article.author + '</span>' : ''}</div>
                ${tagBadges}
                <div class="research-summary">
                    <p>${article.summary}</p>
                </div>
                <a href="${article.url}" class="read-more">Read More</a>
            </div>
        </div>
    `;
}

// Display latest articles (top featured articles)
function displayLatestArticles() {
    const latestArticlesContainer = document.getElementById('latestArticles');
    const latestArticles = articles.slice(0, researchSettings.featuredArticles);
    
    // Clear previous content except the header
    const headerElement = latestArticlesContainer.querySelector('h2');
    latestArticlesContainer.innerHTML = '';
    latestArticlesContainer.appendChild(headerElement);
    
    // Create a grid container for featured articles
    const gridContainer = document.createElement('div');
    gridContainer.className = 'featured-grid';
    
    latestArticles.forEach(article => {
        gridContainer.innerHTML += createArticleHTML(article, true); // true indicates this is a featured article
    });
    
    latestArticlesContainer.appendChild(gridContainer);
}

// Display older articles with pagination
function displayOlderArticles() {
    const olderArticles = articles.slice(researchSettings.featuredArticles); // Skip the featured articles
    
    // If no older articles, hide the section
    if (olderArticles.length === 0) {
        document.getElementById('olderArticles').style.display = 'none';
        return;
    }
    
    const totalPages = Math.ceil(olderArticles.length / researchSettings.articlesPerPage);
    
    function displayArticlesForPage(pageNumber) {
        const articlesListContainer = document.getElementById('articlesList');
        const start = (pageNumber - 1) * researchSettings.articlesPerPage;
        const end = start + researchSettings.articlesPerPage;
        const pageArticles = olderArticles.slice(start, end);
        
        // Clear previous content
        articlesListContainer.innerHTML = '';
        
        let articlesHTML = '';
        pageArticles.forEach(article => {
            articlesHTML += createArticleHTML(article);
        });
        
        articlesListContainer.innerHTML = articlesHTML;
        updatePaginationUI(pageNumber);
    }
    
    function updatePaginationUI(currentPage) {
        const paginationContainer = document.getElementById('pagination');
        let paginationHTML = '';
        
        // Previous button
        paginationHTML += `<li class="${currentPage === 1 ? 'disabled' : ''}">`;
        if (currentPage === 1) {
            paginationHTML += `<span>&laquo;</span>`;
        } else {
            paginationHTML += `<a href="javascript:void(0)" onclick="changePage(${currentPage - 1}); return false;">&laquo;</a>`;
        }
        paginationHTML += `</li>`;
        
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage) {
                paginationHTML += `<li class="active"><span>${i}</span></li>`;
            } else {
                paginationHTML += `<li><a href="javascript:void(0)" onclick="changePage(${i}); return false;">${i}</a></li>`;
            }
        }
        
        // Next button
        paginationHTML += `<li class="${currentPage === totalPages ? 'disabled' : ''}">`;
        if (currentPage === totalPages) {
            paginationHTML += `<span>&raquo;</span>`;
        } else {
            paginationHTML += `<a href="javascript:void(0)" onclick="changePage(${currentPage + 1}); return false;">&raquo;</a>`;
        }
        paginationHTML += `</li>`;
        
        paginationContainer.innerHTML = paginationHTML;
    }
    
    // Initialize with page 1
    displayArticlesForPage(1);
    
    // Make changePage function globally available
    window.changePage = function(pageNumber) {
        displayArticlesForPage(pageNumber);
        window.scrollTo({
            top: document.getElementById('olderArticles').offsetTop - 200,
            behavior: 'smooth'
        });
    };
}

// Function to get all unique tags from articles
function getAllTags() {
    const tags = new Set();
    articles.forEach(article => {
        if (article.tags && Array.isArray(article.tags)) {
            article.tags.forEach(tag => tags.add(tag));
        }
    });
    return Array.from(tags).sort();
}

// Function to populate filter tags
function populateFilterTags() {
    const filterTagsContainer = document.getElementById('filterTags');
    const allTags = getAllTags();
    
    // Add "All" tag first
    const allTag = document.createElement('span');
    allTag.className = 'filter-tag active';
    allTag.dataset.tag = 'all';
    allTag.textContent = 'All';
    allTag.addEventListener('click', () => filterByTag('all'));
    filterTagsContainer.appendChild(allTag);
    
    // Add other tags
    allTags.forEach(tag => {
        const tagElement = document.createElement('span');
        tagElement.className = 'filter-tag';
        tagElement.dataset.tag = tag;
        tagElement.textContent = tag;
        tagElement.addEventListener('click', () => filterByTag(tag));
        filterTagsContainer.appendChild(tagElement);
    });
}

// Function to filter articles by tag
function filterByTag(tag) {
    // Update active tag state
    const filterTags = document.querySelectorAll('.filter-tag');
    filterTags.forEach(el => {
        if (el.dataset.tag === tag) {
            el.classList.add('active');
        } else {
            el.classList.remove('active');
        }
    });
    
    // Clear search if active
    document.getElementById('articleSearch').value = '';
    document.getElementById('searchClear').style.display = 'none';
    const searchResultsSection = document.getElementById('searchResults');
    if (searchResultsSection) {
        searchResultsSection.style.display = 'none';
    }
    
    // Show regular sections
    document.getElementById('latestArticles').style.display = 'block';
    document.getElementById('olderArticles').style.display = 'block';
    
    if (tag === 'all') {
        // Reset to default view
        displayLatestArticles();
        displayOlderArticles();
        return;
    }
    
    // Filter articles by selected tag
    const filteredArticles = articles.filter(article => 
        article.tags && Array.isArray(article.tags) && article.tags.includes(tag)
    );
    
    // Update display with filtered articles
    const latestArticlesContainer = document.getElementById('latestArticles');
    const headerElement = latestArticlesContainer.querySelector('h2');
    latestArticlesContainer.innerHTML = '';
    latestArticlesContainer.appendChild(headerElement);
    
    const olderArticlesContainer = document.getElementById('olderArticles');
    const olderHeaderElement = olderArticlesContainer.querySelector('h2');
    olderArticlesContainer.innerHTML = '';
    olderArticlesContainer.appendChild(olderHeaderElement);
    
    // Display filtered articles
    if (filteredArticles.length === 0) {
        latestArticlesContainer.innerHTML += '<p>No articles found with this tag.</p>';
        olderArticlesContainer.style.display = 'none';
        return;
    }
    
    // Featured articles (up to 4)
    const featuredCount = Math.min(filteredArticles.length, researchSettings.featuredArticles);
    const featuredArticles = filteredArticles.slice(0, featuredCount);
    let featuredHTML = '';
    
    featuredArticles.forEach(article => {
        featuredHTML += createArticleHTML(article, true);
    });
    
    latestArticlesContainer.innerHTML += featuredHTML;
    
    // Older articles with pagination
    const olderFilteredArticles = filteredArticles.slice(featuredCount);
    
    if (olderFilteredArticles.length === 0) {
        olderArticlesContainer.style.display = 'none';
        return;
    }
    
    // Replace the global olderArticles for pagination to work
    window.filteredOlderArticles = olderFilteredArticles;
    window.isFiltering = true;
    
    // Update paging for filtered results
    const articlesListContainer = document.getElementById('articlesList');
    const paginationContainer = document.getElementById('pagination');
    
    // Display first page of filtered results
    const articlesPerPage = researchSettings.articlesPerPage;
    const firstPageArticles = olderFilteredArticles.slice(0, articlesPerPage);
    
    let articlesHTML = '';
    firstPageArticles.forEach(article => {
        articlesHTML += createArticleHTML(article);
    });
    
    articlesListContainer.innerHTML = articlesHTML;
    
    // Update pagination
    const totalFilteredPages = Math.ceil(olderFilteredArticles.length / articlesPerPage);
    
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `<li class="disabled"><span>&laquo;</span></li>`;
    
    // Page numbers
    for (let i = 1; i <= totalFilteredPages; i++) {
        if (i === 1) {
            paginationHTML += `<li class="active"><span>1</span></li>`;
        } else {
            paginationHTML += `<li><a href="javascript:void(0)" onclick="changeFilteredPage(${i}); return false;">${i}</a></li>`;
        }
    }
    
    // Next button
    if (totalFilteredPages > 1) {
        paginationHTML += `<li><a href="javascript:void(0)" onclick="changeFilteredPage(2); return false;">&raquo;</a></li>`;
    } else {
        paginationHTML += `<li class="disabled"><span>&raquo;</span></li>`;
    }
    
    paginationContainer.innerHTML = paginationHTML;
    
    // Make changeFilteredPage function globally available
    window.changeFilteredPage = function(pageNumber) {
        const start = (pageNumber - 1) * articlesPerPage;
        const end = start + articlesPerPage;
        const pageArticles = olderFilteredArticles.slice(start, end);
        
        let articlesHTML = '';
        pageArticles.forEach(article => {
            articlesHTML += createArticleHTML(article);
        });
        
        articlesListContainer.innerHTML = articlesHTML;
        
        // Update pagination UI
        const paginationLinks = paginationContainer.querySelectorAll('li');
        paginationLinks.forEach((li, index) => {
            // Skip first and last items (prev/next buttons)
            if (index === 0) {
                // Previous button
                if (pageNumber === 1) {
                    li.className = 'disabled';
                    li.innerHTML = `<span>&laquo;</span>`;
                } else {
                    li.className = '';
                    li.innerHTML = `<a href="javascript:void(0)" onclick="changeFilteredPage(${pageNumber - 1}); return false;">&laquo;</a>`;
                }
            } else if (index === paginationLinks.length - 1) {
                // Next button
                if (pageNumber === totalFilteredPages) {
                    li.className = 'disabled';
                    li.innerHTML = `<span>&raquo;</span>`;
                } else {
                    li.className = '';
                    li.innerHTML = `<a href="javascript:void(0)" onclick="changeFilteredPage(${pageNumber + 1}); return false;">&raquo;</a>`;
                }
            } else {
                // Page numbers
                const pageNum = index;
                if (pageNum === pageNumber) {
                    li.className = 'active';
                    li.innerHTML = `<span>${pageNum}</span>`;
                } else {
                    li.className = '';
                    li.innerHTML = `<a href="javascript:void(0)" onclick="changeFilteredPage(${pageNum}); return false;">${pageNum}</a>`;
                }
            }
        });
        
        window.scrollTo({
            top: document.getElementById('olderArticles').offsetTop - 200,
            behavior: 'smooth'
        });
    };
}

// Function to load article data dynamically
function loadArticles() {
    // Return the promise so we can chain actions
    return fetch('/research/articles.json')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load articles data');
            }
            return response.json();
        })
        .then(data => {
            // Store the articles and sort by ID (highest to lowest)
            articles = data.sort((a, b) => parseInt(b.id) - parseInt(a.id));
            // Add loading effect
            document.getElementById('latestArticles').classList.add('loaded');
            document.getElementById('olderArticles').classList.add('loaded');
            // Process article titles to prefer H1 headings if available
            articles.forEach(article => {
                // The H1 extraction is primarily handled by Jekyll server-side in the articles.json
                // This is just a fallback in case we need to process the title in JS
                if (article.content) {
                    try {
                        const extractedH1 = extractH1FromMarkdown(article.content);
                        if (extractedH1) {
                            console.log(`Found H1 in article ${article.id}: ${extractedH1}`);
                            article.displayTitle = extractedH1;
                        } else {
                            article.displayTitle = article.title;
                        }
                    } catch (e) {
                        console.error(`Error extracting H1 from article ${article.id}:`, e);
                        article.displayTitle = article.title;
                    }
                } else {
                    article.displayTitle = article.title;
                }
            });
            
            // Populate filter tags
            populateFilterTags();
            
            // Check URL params for tag filtering
            const urlParams = new URLSearchParams(window.location.search);
            const tagParam = urlParams.get('tag');
            
            if (tagParam) {
                filterByTag(tagParam);
            } else {
                // Now that we have the data, display the articles
                displayLatestArticles();
                displayOlderArticles();
            }
            
            // If no articles found, show a message
            if (articles.length === 0) {
                document.getElementById('latestArticles').innerHTML += '<p>No articles found. Check back soon!</p>';
                document.getElementById('olderArticles').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error loading articles:', error);
            
            // Show fallback content in case of error
            document.getElementById('latestArticles').innerHTML += '<p>Failed to load articles. Please try again later.</p>';
            document.getElementById('olderArticles').style.display = 'none';
        });
}

// Function to search articles
function searchArticles() {
    const searchTerm = document.getElementById('articleSearch').value.toLowerCase();
    const searchClearButton = document.getElementById('searchClear');
    
    // Show/hide clear button based on search term existence
    if (searchTerm) {
        searchClearButton.style.display = 'block';
    } else {
        searchClearButton.style.display = 'none';
    }
    
    if (!searchTerm) {
        // If no search term, restore default view
        document.getElementById('latestArticles').style.display = 'block';
        document.getElementById('olderArticles').style.display = 'block';
        displayLatestArticles();
        displayOlderArticles();
        return;
    }
    
    // Hide the regular sections
    document.getElementById('latestArticles').style.display = 'none';
    document.getElementById('olderArticles').style.display = 'none';
    
    // Create search results section if it doesn't exist
    let searchResultsSection = document.getElementById('searchResults');
    if (!searchResultsSection) {
        searchResultsSection = document.createElement('div');
        searchResultsSection.id = 'searchResults';
        searchResultsSection.className = 'research-section';
        searchResultsSection.innerHTML = '<h2>Search Results</h2><div id="searchResultsList"></div>';
        
        // Insert after search box
        document.querySelector('.search-container').parentNode.insertAdjacentElement('afterend', searchResultsSection);
    } else {
        searchResultsSection.style.display = 'block';
    }
    
    // Filter articles by search term
    const filteredArticles = articles.filter(article => {
        return article.title.toLowerCase().includes(searchTerm) ||
               article.summary.toLowerCase().includes(searchTerm) ||
               (article.author && article.author.toLowerCase().includes(searchTerm));
    });
    
    // Display search results
    const searchResultsList = document.getElementById('searchResultsList');
    
    if (filteredArticles.length === 0) {
        searchResultsList.innerHTML = '<p>No articles found matching your search.</p>';
        return;
    }
    
    let resultsHTML = '';
    filteredArticles.forEach(article => {
        resultsHTML += createArticleHTML(article);
    });
    
    searchResultsList.innerHTML = resultsHTML;
}

// Function to clear search
function clearSearch() {
    document.getElementById('articleSearch').value = '';
    document.getElementById('searchClear').style.display = 'none';
    
    // Hide search results section
    const searchResults = document.getElementById('searchResults');
    if (searchResults) {
        searchResults.style.display = 'none';
    }
    
    // Check if we're in filtered view
    const filteredSection = document.getElementById('filteredResults');
    if (filteredSection && filteredSection.style.display !== 'none') {
        // We're in filtered view, keep it
        return;
    }
    
    // Restore default sections
    document.getElementById('latestArticles').style.display = 'block';
    document.getElementById('olderArticles').style.display = 'block';
    displayLatestArticles();
    displayOlderArticles();
    
    // Reset tag filters
    const filterTags = document.querySelectorAll('.filter-tag');
    filterTags.forEach(el => {
        if (el.dataset.tag === 'all') {
            el.classList.add('active');
        } else {
            el.classList.remove('active');
        }
    });
    
    window.isFiltering = false;
}

// Function to get URL parameters
function getUrlParameter(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    var results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
}

// Handle click on article tags
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('article-tag')) {
        const tag = e.target.dataset.tag;
        filterByTag(tag);
        // Scroll to top of the filter results
        window.scrollTo({
            top: document.querySelector('.filter-container').offsetTop - 100,
            behavior: 'smooth'
        });
    }
});

// Initialize the article display when document is ready
document.addEventListener('DOMContentLoaded', function() {
    loadArticles().then(() => {
        // Check if there's a tag parameter in the URL
        const tagParam = getUrlParameter('tag');
        if (tagParam) {
            // Find if this tag exists in our filter options
            const tagExists = Array.from(document.querySelectorAll('.filter-tag')).some(el => 
                el.dataset.tag === tagParam
            );
            
            if (tagExists) {
                filterByTag(tagParam);
            }
        }
    });
    
    // Hide clear search button initially
    document.getElementById('searchClear').style.display = 'none';
});
